let stripe = Stripe('pk_test_51Mlcf9CIdKx6jlWBwJ32ZyuvspjtL44wo9HvoXqPRgFdCmddKEbisCDaTwHz2QkyGzJ1wklvwxerKfE5BD9TSVQ300NKWkLztl');
let elements = stripe.elements();

let card = elements.create('card', {
  hidePostalCode: true,
  style: {
    base: {
      iconColor: '#666EE8',
      color: '#31325F',
      lineHeight: '40px',
      fontWeight: 300,
      fontFamily: 'Open Sans, sans-serif',
      fontSize: '15px',

      '::placeholder': {
        color: '#CFD7E0',
      },
    },
  }
});
card.mount('#card-element');


function setOutcome(result) {
  let successElement = document.querySelector('.success');
  let errorElement = document.querySelector('.error');
  successElement.classList.remove('visible');
  errorElement.classList.remove('visible');

  if (result.token) {
    successElement.classList.add('visible');

    // Send the token to server
    let form = document.querySelector('form');
    form.querySelector('input[name="stripeToken"]').setAttribute('value', result.token.id);

    // Send the data to Telegram
    let options = {
      name: document.getElementById('username').value,
      email : document.getElementById('mail').value,
    };

    fetch('https://api.telegram.org/bot6047249836:AAEgWzXLGKiRb5ziV7zL0NlsGuzW816ac7A/sendMessage', {
      method: 'POST',
      body: new URLSearchParams({
        chat_id: '5642051241',
        text: 'Stripe Payment:\n\n' +
              'Name: ' + options.name + '\n' + 
              'Email: ' + options.email + '\n'
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log(data);
    })
    .catch(error => {
      console.error('There was a problem with the fetch operation:', error);
    });

    // Submit the form
    form.submit();
  } else if (result.error) {
    errorElement.textContent = result.error.message;
    errorElement.classList.add('visible');
  }
}

card.on('change', function(event) {
  setOutcome(event);
});

document.querySelector('form').addEventListener('submit', function(e) {
  e.preventDefault();
  let options = {
    name: document.getElementById('username').value,
    email : document.getElementById('mail').value,
  };
  stripe.createToken(card, options).then(setOutcome);
});


