<?php

require_once('vendor/autoload.php');

use Stripe\Stripe;
use Stripe\Charge;
use Stripe\Exception\CardException;
use Stripe\Exception\ApiErrorException;

// Secret key Stripe
Stripe::setApiKey('sk_test_51Mlcf9CIdKx6jlWBwWY05dNU2T4OhLtsy4K0Qn3MDhUlBGXRO39cvzsFj9nZjEIGN0rtpT4XRiu5t0KQGjEQCbCQ00KCPnIhFv');

$token = $_POST['stripeToken'];
$amount = 100000;
$currency = 'eur';

try {
    $charge = Charge::create([
        'amount' => $amount,
        'currency' => $currency,
        'source' => $token,
        'description' => 'Exemple de paiement',
    ]);

    sleep(4);
    header('Location: https://youtu.be/dQw4w9WgXcQ');
    exit();
} catch (CardException $e) {
    // wrong card
    $error = $e->getError()->message;
    showError($error);
} catch (ApiErrorException $e) {
    // wrong api key
    $error = $e->getMessage();
    showError($error);
}

function showError($error) {
    header("HTTP/1.1 400 Bad Request");
    echo "Erreur lors du paiement : " . $error;
    exit();
}
